# Руководство по скрипту "Анализ ключевых точек" (v2.1.0)

## 1. Назначение

Скрипт **"Анализ ключевых точек"** является промежуточным этапом обработки, который обогащает данные, полученные после анализа и кластеризации. Его основная задача — на основе точных координат ключевых точек лица (`landmark_2d_106`) и данных о позе (`pose`) вычислить и записать более высокоуровневые характеристики:

*   **Состояние глаз:** Открыты, закрыты, прищурены.
*   **Состояние рта:** Закрыт, приоткрыт, открыт.
*   **Положение головы:** Фронтальное, в профиль и т.д.

Эта информация критически важна для последующих этапов, таких как создание детализированных XMP-тегов и фильтрации фотографий.

## 2. Логика работы

1.  **Автоматическое определение путей:** Скрипт автоматически определяет путь к папке с результатами предыдущих этапов на основе информации о текущем рабочем процессе из PySM:
    *   **Папка с данными:** `{папка_сессии}/{имя_сессии}/Output/Analysis_{папка_фото_с_камеры}`
    Вам больше не нужно указывать этот путь вручную.

2.  **Загрузка данных:** Скрипт загружает из этой папки JSON-файлы (`info_portrait_faces.json` и `info_group_faces.json`).

3.  **Загрузка порогов:** Из локального файла `config.toml` считываются численные пороги, которые определяют, как интерпретировать рассчитанные метрики (например, какое значение "соотношения сторон глаза" считать закрытым).

4.  **Итеративный анализ:** Скрипт проходит по каждому лицу в каждом JSON-файле и выполняет вычисления для глаз, рта и позы головы.

5.  **Обновление JSON:** Результаты анализа добавляются в виде нового поля `keypoint_analysis` к записи о каждом лице прямо в загруженные JSON-данные.

6.  **Сохранение результатов:** После обработки всех лиц обновленные JSON-файлы перезаписываются на диск. Скрипт также может создавать файлы со статистикой и рекомендациями по настройке порогов.

## 3. Параметры

-   **`a_ak_config_file`** (служебный):
    -   **Назначение:** Путь к файлу `config.toml` с техническими параметрами (порогами) для анализа.
    -   **Источник:** Определяется автоматически.```

