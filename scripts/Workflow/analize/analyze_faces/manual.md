# Руководство по скрипту "Анализ лиц" (v2.1.0)

## 1. Назначение

Скрипт **"Анализ лиц"** является ядром всего рабочего процесса. Он выполняет глубокий анализ изображений с использованием нейросетевых моделей. Его задача — найти все лица на подготовленных JPEG-файлах, извлечь их ключевые характеристики и сохранить эту информацию в структурированном виде для последующих этапов.

## 2. Логика работы

1.  **Загрузка конфигурации:** Скрипт использует локальный файл `config.toml`, который содержит все технические параметры моделей (`insightface`, модели для анализа атрибутов) и настройки ONNX-провайдера.

2.  **Автоматическое определение путей:** Скрипт автоматически определяет рабочие папки на основе информации о текущем рабочем процессе из PySM:
    *   **Входная папка:** `{папка_сессии}/{имя_сессии}/Output/Analysis_{папка_фото_с_камеры}/JPG`
    *   **Выходная папка:** `{папка_сессии}/{имя_сессии}/Output/Analysis_{папка_фото_с_камеры}`
    Вам больше не нужно указывать эти пути вручную.

3.  **Поиск изображений:** Скрипт сканирует входную папку и находит все файлы с расширением `.jpg`.

4.  **Параллельный анализ:** Для максимальной производительности анализ изображений выполняется в несколько потоков. Каждый поток обрабатывает одно изображение:
    *   **Детекция:** На изображении находятся все лица с помощью модели `insightface`.
    *   **Извлечение эмбеддинга:** Для каждого найденного лица вычисляется его уникальное векторное представление (эмбеддинг).
    *   **Анализ атрибутов:** Для каждого лица (если включено в `config.toml`) запускаются дополнительные нейросети для определения пола, возраста, эмоций и состояния глаз.

5.  **Сохранение результатов:** После обработки всех изображений скрипт сохраняет результаты в выходную папку:
    *   **JSON-файлы:** Создаются два файла (`info_portrait_faces.json` и `info_group_faces.json`) со всеми метаданными лиц.
    *   **Эмбеддинги:** В подпапке `_Embeddings` создаются `.npy` файлы с числовыми данными эмбеддингов и `.json` файлы-индексы для них.

## 3. Параметры

-   **`a_af_config_file`** (служебный):
    -   **Назначение:** Путь к файлу `config.toml`, содержащему технические настройки моделей.
    -   **Источник:** Обычно определяется автоматически и не требует изменения.

-   **`all_threads`**:
    -   **Назначение:** Количество одновременных потоков для ускорения анализа.
    -   **Значение по умолчанию:** `0` (автоматическое определение по количеству ядер процессора).