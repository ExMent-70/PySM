# Руководство по скрипту "Кластеризация и сопоставление лиц" (v2.1.0)

## 1. Назначение

Скрипт **"Кластеризация и сопоставление лиц"** является третьим этапом в рабочем процессе анализа. Его главная задача — взять "сырые" данные о найденных лицах и превратить их в осмысленную структуру:

1.  **Сгруппировать** похожие портретные фотографии в кластеры, чтобы определить уникальных людей.
2.  **Присвоить** каждому кластеру имя из предоставленного списка.
3.  **Идентифицировать** этих же людей на групповых фотографиях, устанавливая связь между портретными и групповыми снимками.

## 2. Логика работы

1.  **Автоматическое определение путей:** Скрипт автоматически определяет рабочие папки и файлы на основе информации о текущем рабочем процессе из PySM:
    *   **Папка с данными:** `{папка_сессии}/{имя_сессии}/Output/Analysis_{папка_фото_с_камеры}`
    *   **Файл со списком имен:** `{папка_сессии}/{имя_сессии}/{папка_фото_с_камеры}_{имя_файла_списка}`
    Вам больше не нужно указывать эти пути вручную.

2.  **Загрузка данных:** Скрипт загружает всю необходимую информацию из автоматически определенной папки с данными: JSON-файлы с метаданными и `.npy`-файлы с эмбеддингами лиц.

3.  **Кластеризация портретов:**
    *   Скрипт берет эмбеддинги всех лиц с портретных фотографий.
    *   Используя выбранный алгоритм (`a_cf_algorithm`), он группирует схожие эмбеддинги. Технические параметры алгоритма берутся из локального файла `config.toml`.
    *   Каждый портрет получает метку кластера (например, `0`, `1`, `2`...) или метку шума (`-1`).

4.  **Присвоение имен:**
    *   Скрипт загружает текстовый файл со списком имен.
    *   Каждому полученному кластеру последовательно присваивается имя из списка.

5.  **Сопоставление (Matching):**
    *   Для каждого именованного портретного кластера вычисляется "эталон" лица.
    *   Каждое лицо с групповых фотографий сравнивается с этими эталонами, и если сходство достаточно велико, ему присваивается соответствующее имя.

6.  **Сохранение результатов:** Скрипт **обновляет существующие** JSON-файлы с метаданными, добавляя в них информацию о кластерах и именах.

## 3. Параметры

-   **`a_cf_algorithm`**:
    -   **Назначение:** Выбор математического алгоритма для группировки портретов. `DBSCAN` быстрее, но чувствителен к параметру `eps`. `HDBSCAN` более гибкий, но может работать медленнее.
    -   **Значение по умолчанию:** `dbscan`.

-   **`a_cf_config_file`** (служебный):
    -   **Назначение:** Путь к файлу `config.toml` с техническими параметрами алгоритмов.
    -   **Источник:** Определяется автоматически.